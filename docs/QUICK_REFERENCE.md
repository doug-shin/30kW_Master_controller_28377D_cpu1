# 30kW Master Controller ë¹ ë¥¸ ì°¸ì¡° ê°€ì´ë“œ

**ëŒ€ìƒ**: ì‹ ê·œ ê°œë°œì, ê¸´ê¸‰ ë””ë²„ê¹…, ë¹ ë¥¸ ì½”ë“œ íƒìƒ‰
**ìµœì¢… ì—…ë°ì´íŠ¸**: 2025ë…„ 10ì›” 27ì¼
**ë²„ì „**: 2.2.0

---

## ğŸš€ ë¹ ë¥¸ ì‹œì‘

### 1ë¶„ ì•ˆì— í”„ë¡œì íŠ¸ ì´í•´í•˜ê¸°

```
ì´ íŒì›¨ì–´ëŠ” ë¬´ì—‡ì¸ê°€?
â†’ 30kW ë°°í„°ë¦¬ ì „ë ¥ ë³€í™˜ ì‹œìŠ¤í…œ ë§ˆìŠ¤í„° ì œì–´ê¸°
â†’ TI F28377D DSP (200MHz) ê¸°ë°˜
â†’ 100kHz ì‹¤ì‹œê°„ ì œì–´, CLA ê°€ì† PI ì œì–´

ì£¼ìš” ê¸°ëŠ¥ì€?
â†’ ìµœëŒ€ 31ê°œ ìŠ¬ë ˆì´ë¸Œ ëª¨ë“ˆ ì œì–´ (CAN)
â†’ ê³¼ì „ì••/ê³¼ì „ë¥˜/ê³¼ì˜¨ ë³´í˜¸
â†’ ê°œë³„/ë³‘ë ¬ ìš´ì „ ëª¨ë“œ
â†’ SCADA í†µì‹  (115200 baud)

ì–´ë””ì„œë¶€í„° ì½ì–´ì•¼ í•˜ë‚˜?
1. HABA_main.c (ì—”íŠ¸ë¦¬ í¬ì¸íŠ¸, 277ë¼ì¸)
2. HABA_control.c (ì œì–´ ë¡œì§, Phase í•¨ìˆ˜ë“¤)
3. HABA_globals.h (ë³€ìˆ˜/ìƒìˆ˜ ì •ì˜)
```

---

## ğŸ“ ì¤‘ìš” íŒŒì¼ ìœ„ì¹˜

| ì°¾ê³  ìˆëŠ” ê²ƒ | íŒŒì¼ | ë¼ì¸ ë²ˆí˜¸ |
|--------------|------|-----------|
| **ë©”ì¸ ë£¨í”„** | `HABA_main.c` | 115~184 |
| **100kHz ISR** | `HABA_main.c` | 196~272 |
| **Phase 0 (ì„¼ì‹±)** | `HABA_control.c` | 105~149 |
| **Phase 1 (PI ì ìš©)** | `HABA_control.c` | 173~323 |
| **PI ì œì–´ê¸° (CLA)** | `HABA_cla_tasks.cla` | 17~53 |
| **ì „ì•• ìº˜ë¦¬ë¸Œë ˆì´ì…˜** | `HABA_control.c` | 114~125 |
| **CAN ìŠ¬ë ˆì´ë¸Œ ì½ê¸°** | `HABA_control.c` | ~600 |
| **SCADA íŒŒì‹±** | `HABA_control.c` | ~900 |
| **GPIO ì´ˆê¸°í™”** | `HABA_setup.c` | ~100 |
| **CLA ì´ˆê¸°í™”** | `HABA_setup.c` | ~350 |

---

## âš¡ í•µì‹¬ ì œì–´ ë£¨í”„ (100kHz)

```
INT_EPWM1_ISR (10Î¼s ì£¼ê¸°)
â”‚
â”œâ”€ Read_FPGA_Data()             // SPIë¡œ V_out, V_batt, I_out ì½ê¸°
â”‚
â”œâ”€ 5-Phase ìˆœí™˜ (20kHz)
â”‚  â”œâ”€ Phase 0: Sensing_And_Trigger_PI()      ~2.0Î¼s
â”‚  â”‚   â””â”€ ì „ì•• í‰ê·  â†’ ìº˜ë¦¬ë¸Œë ˆì´ì…˜ â†’ CLA Force
â”‚  â”‚
â”‚  â”œâ”€ Phase 1: Apply_PI_And_Convert_DAC()    ~3.0Î¼s
â”‚  â”‚   â””â”€ CLA ê²°ê³¼ ì‚¬ìš© â†’ ì „ë¥˜ ì œí•œ â†’ DAC ë³€í™˜
â”‚  â”‚
â”‚  â”œâ”€ Phase 2: Transmit_Current_Command()    ~1.5Î¼s
â”‚  â”‚   â””â”€ RS485 ì „ë¥˜ ì§€ë ¹ ì†¡ì‹ 
â”‚  â”‚
â”‚  â”œâ”€ Phase 3: Check_System_Safety()         ~1.5Î¼s
â”‚  â”‚   â””â”€ ê³ ì¥ ì²´í¬ â†’ ë¦´ë ˆì´ ì œì–´
â”‚  â”‚
â”‚  â””â”€ Phase 4: Update_Monitoring_And_Sequence() ~1.0Î¼s
â”‚      â””â”€ í‰ê·  ê³„ì‚° â†’ ì†Œí”„íŠ¸ìŠ¤íƒ€íŠ¸ â†’ ì‹œí€€ìŠ¤
â”‚
â””â”€ íƒ€ì´ë° í”Œë˜ê·¸ ìƒì„± (1ms, 10ms, 50ms)
```

---

## ğŸ”§ ìì£¼ ìˆ˜ì •í•˜ëŠ” ì½”ë“œ

### 1ï¸âƒ£ ë³´í˜¸ ì„ê³„ê°’ ë³€ê²½
```c
// HABA_globals.h:106-109
#define OVER_VOLTAGE  1400      // ê³¼ì „ì•• (V)
#define OVER_CURRENT  88.0f     // ê³¼ì „ë¥˜ (A)
#define OVER_TEMP     120       // ê³¼ì˜¨ë„ (Â°C)
```

### 2ï¸âƒ£ ì „ë¥˜ ì œí•œ ë³€ê²½
```c
// HABA_globals.h:91-92
#define CURRENT_LIMIT_INDIVIDUAL  480.0f   // ê°œë³„ ëª¨ë“œ (A)
#define CURRENT_LIMIT_PARALLEL    960.0f   // ë³‘ë ¬ ëª¨ë“œ (A)
```

### 3ï¸âƒ£ PI ê²Œì¸ íŠœë‹
```c
// HABA_setup.c: Init_CPU1_CLA1()
pi_charge.Kp = 1.0f;
pi_charge.Ki = 3000.0f * 50e-6f;  // = 0.15 (ì´ì‚° ì‹œê°„)
pi_charge.Umax = 80.0f;           // ì¶œë ¥ ìƒí•œ
pi_charge.Umin = -2.0f;           // ì¶œë ¥ í•˜í•œ
pi_charge.Imax = 80.0f;           // ì ë¶„ê¸° ìƒí•œ (ë™ì  ì—…ë°ì´íŠ¸ë¨)
pi_charge.Imin = -2.0f;           // ì ë¶„ê¸° í•˜í•œ
```

### 4ï¸âƒ£ ì „ì•• ìº˜ë¦¬ë¸Œë ˆì´ì…˜
```c
// HABA_control.c: Sensing_And_Trigger_PI()
// Step 2: ì‹¤ì¸¡ ìº˜ë¦¬ë¸Œë ˆì´ì…˜
V_out = (V_out_uncal + 0.091694057f) * 0.9926000888f;
V_batt = (V_batt_uncal - 0.3058461657f) * 0.9945009708f;
```

**ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì ˆì°¨**:
1. ê¸°ì¤€ ì „ì••ê³„ë¡œ ì‹¤ì œ ì „ì•• ì¸¡ì •
2. `V_out_uncal`, `V_batt_uncal` ê°’ ì½ê¸° (ë””ë²„ê±°)
3. ì„ í˜• íšŒê·€ë¡œ ì˜¤í”„ì…‹/ê²Œì¸ ê³„ì‚°
4. ìƒìˆ˜ ì—…ë°ì´íŠ¸

### 5ï¸âƒ£ SCADA í”„ë¡œí† ì½œ ìˆ˜ì •
```c
// HABA_control.c: Parse_SCADA_Command()
// íŒ¨í‚· êµ¬ì¡°: [STX][CMD][Param1_H][Param1_L][Param2_H][Param2_L]
//             [Param3_H][Param3_L][CRC32_3][CRC32_2][CRC32_1][CRC32_0][ETX]

uint8_t cmd = scada_rx_buffer[1];  // ëª…ë ¹ ë°”ì´íŠ¸
// bit[7]: ì œì–´ ëª¨ë“œ (0=ì¶©ë°©ì „, 1=ë°°í„°ë¦¬)
// bit[6]: Ready ìƒíƒœ
// bit[5]: Run ìƒíƒœ
// bit[4]: Parallel ëª¨ë“œ
```

---

## ğŸ› ë””ë²„ê¹… íŒ

### ë¬¸ì œ: ISRì´ ë„ˆë¬´ ëŠë¦¼
```c
// HABA_globals.h:32
#define ENABLE_TIMING_DEBUG  1  // í™œì„±í™”

// ì˜¤ì‹¤ë¡œìŠ¤ì½”í”„ë¡œ GPIO90, 91, 92 ì¸¡ì •
// GPIO90: ISR ì‹¤í–‰ ì‹œê°„ (ëª©í‘œ <2Î¼s/phase)
```

### ë¬¸ì œ: CAN ìŠ¬ë ˆì´ë¸Œ ì‘ë‹µ ì—†ìŒ
```c
// HABA_control.c: Read_CAN_Slave()
// ë””ë²„ê±° ë¸Œë ˆì´í¬í¬ì¸íŠ¸ ì„¤ì •
if (msgStatus & CAN_STATUS_RXOK) {
    // ì—¬ê¸°ì„œ ë©ˆì¶”ë©´ ë©”ì‹œì§€ ìˆ˜ì‹ ë¨
    // rxData[0~3] í™•ì¸
}

// can_rx_fault_cnt[slave_id] í™•ì¸ (10000 ì´ìƒì´ë©´ í†µì‹  ëŠê¹€)
```

### ë¬¸ì œ: PI ì œì–´ ë¶ˆì•ˆì •
```c
// HABA_cla_tasks.cla
// CLA ë””ë²„ê·¸ ë³€ìˆ˜ í™œì„±í™”
cla_cnt++;  // CLA ì‹¤í–‰ ì¹´ìš´í„° (ë§¤ ì‚¬ì´í´ ì¦ê°€í•´ì•¼ í•¨)

// CPUì—ì„œ í™•ì¸
// I_PI_charge_out, I_PI_discharge_out ê°’ ëª¨ë‹ˆí„°ë§
// ë°œì‚°í•˜ë©´ ê²Œì¸ ë‚®ì¶”ê¸° (Kp, Ki)
```

### ë¬¸ì œ: ë¦´ë ˆì´ ë™ì‘ ì•ˆ í•¨
```c
// HABA_control.c: Check_System_Safety()
if (run == 1 && sequence_step >= SEQ_STEP_PRECHARGE_DONE)
    MAIN_RELAY_ON();  // GPIO8 = 1

// ì²´í¬ë¦¬ìŠ¤íŠ¸:
// 1. run == 1 ì¸ê°€? (ë¹„ìƒ ì •ì§€ ìŠ¤ìœ„ì¹˜ í™•ì¸)
// 2. sequence_step >= 10 ì¸ê°€?
// 3. GPIO8 ì¶œë ¥ í™œì„±í™”ë˜ì—ˆë‚˜? (Init_GPIO_CPU1)
```

---

## ğŸ“Š ì¤‘ìš” ë³€ìˆ˜ ìœ„ì¹˜

### ì „ì••/ì „ë¥˜
```c
V_out           // ìº˜ë¦¬ë¸Œë ˆì´ì…˜ëœ ì¶œë ¥ ì „ì•• (V)
V_batt          // ìº˜ë¦¬ë¸Œë ˆì´ì…˜ëœ ë°°í„°ë¦¬ ì „ì•• (V)
V_out_display   // ë””ìŠ¤í”Œë ˆì´ìš© í‰ê·  (200ìƒ˜í”Œ = 10ms)
V_fb            // PI ì œì–´ í”¼ë“œë°± ì „ì•• (V_out ë˜ëŠ” V_batt)

I_cmd           // ì „ë¥˜ ì§€ë ¹ (SCADA ìˆ˜ì‹ , A)
I_cmd_ramped    // ì†Œí”„íŠ¸ìŠ¤íƒ€íŠ¸ ì ìš© ì „ë¥˜ (A)
I_cmd_filtered  // LPF í•„í„° ì¶œë ¥ (A)
I_cmd_to_slave  // DAC ì¶œë ¥ê°’ (0~65535)
```

### ì œì–´ ëª¨ë“œ (v2.2.0+ êµ¬ì¡°ì²´ ê¸°ë°˜)
```c
// êµ¬ì¡°ì²´ (SCADA ëª…ë ¹ ì…ë ¥)
scada_cmd.control_mode   // CHARGE_DISCHARGE(0), BATTERY(1)
scada_cmd.cmd_ready      // Precharge ì‹œì‘ ëª…ë ¹
scada_cmd.cmd_run        // ìš´ì „ ëª…ë ¹
scada_cmd.parallel_mode  // ë³‘ë ¬ ëª¨ë“œ

// êµ¬ì¡°ì²´ (ë§ˆìŠ¤í„° ìƒíƒœ ì¶œë ¥)
master_status.sequence_step   // SEQ_STEP_IDLE(0), PRECHARGE_DONE(10), NORMAL_RUN(20)
master_status.ready           // Precharge ì™„ë£Œ
master_status.running         // ìš´ì „ ì¤‘
master_status.fault_latched   // ê³ ì¥ ë˜ì¹˜

// ë ˆê±°ì‹œ ë³€ìˆ˜ (í•˜ìœ„ í˜¸í™˜ì„±)
operation_mode  // MODE_STOP(0), MODE_INDIVIDUAL(1), MODE_PARALLEL(2)
sequence_step   // ë ˆê±°ì‹œ (master_statusì™€ ë™ê¸°í™”)
run             // ì‹¤í–‰ í”Œë˜ê·¸ (ë¹„ìƒ ì •ì§€ ìŠ¤ìœ„ì¹˜ + ê³ ì¥ ë˜ì¹˜)
```

### PI ì œì–´ê¸° (CLA ê³µìœ )
```c
pi_charge       // DCL_PI_CLA êµ¬ì¡°ì²´ (ì¶©ì „ ëª¨ë“œ)
pi_discharge    // DCL_PI_CLA êµ¬ì¡°ì²´ (ë°©ì „ ëª¨ë“œ)
pi_cv           // DCL_PI_CLA êµ¬ì¡°ì²´ (ë°°í„°ë¦¬ ëª¨ë“œ)

I_PI_charge_out     // CLA Task 1 ì¶œë ¥ (A)
I_PI_discharge_out  // CLA Task 2 ì¶œë ¥ (A)
I_PI_cv_out         // CLA Task 3 ì¶œë ¥ (A)
```

### ìŠ¬ë ˆì´ë¸Œ ìƒíƒœ
```c
I_out_slave[31]     // ìŠ¬ë ˆì´ë¸Œ ì „ë¥˜ (A)
temp_slave_raw[31]  // ìŠ¬ë ˆì´ë¸Œ ì˜¨ë„ (ì›ì‹œê°’)
DAB_ok_slave[31]    // DAB OK í”Œë˜ê·¸
can_rx_fault_cnt[31] // CAN ìˆ˜ì‹  ê³ ì¥ ì¹´ìš´í„° (>10000ì´ë©´ ê³ ì¥)

// Rev5 Active Slave List (ë™ì  ê´€ë¦¬)
active_slave_list.count        // ì‹¤ì œ ì—°ê²°ëœ ìŠ¬ë ˆì´ë¸Œ ê°œìˆ˜ (0~6)
active_slave_list.slave_ids[]  // í™œì„± ìŠ¬ë ˆì´ë¸Œ ID ë°°ì—´
active_slave_list.last_updated_ms  // ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„
```

---

## ğŸ”Œ í†µì‹  í”„ë¡œí† ì½œ ìš”ì•½

### CAN (500kbps)
```
Master â†’ Slave: 0xE0 (4ë°”ì´íŠ¸)
  [0] = 0xA0 (Buck_EN=1) ë˜ëŠ” 0x00 (OFF)

Slave â†’ Master: 0xF1~0xFF (4ë°”ì´íŠ¸)
  [0] = Current_L (0~255)
  [1] = Current_H + DAB_OK (bit7)
  [2] = Temp (0~255)
  [3] = Reserved
```

### RS485 (5.625Mbps)
```
Master1 â†’ Master2 (SCIA): 4ë°”ì´íŠ¸
  [0] = STX (0x1B)
  [1] = Current_L
  [2] = Current_H
  [3] = ETX (0x03)

Master â†’ Slave (SCIB): 4ë°”ì´íŠ¸ (ë™ì¼ í˜•ì‹)
```

### SCADA (115200 baud)
```
ìˆ˜ì‹  (SCADA â†’ Master): 13ë°”ì´íŠ¸
  [0] = STX (0x1B)
  [1] = CMD (ì œì–´ ëª…ë ¹)
  [2~7] = Param1~3 (Big-endian)
  [8~11] = CRC-32
  [12] = ETX (0x03)

ì†¡ì‹  (Master â†’ SCADA):
  - ì‹œìŠ¤í…œ ì „ì••: 7ë°”ì´íŠ¸ (50ms ì£¼ê¸°)
  - ìŠ¬ë ˆì´ë¸Œ ìƒíƒœ: 7ë°”ì´íŠ¸Ã—15 (10ms ì£¼ê¸°)
```

---

## ğŸ¯ ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬

| í•­ëª© | ì¸¡ì •ê°’ | ëª©í‘œê°’ | ìƒíƒœ |
|------|--------|--------|------|
| ISR ì‹¤í–‰ ì‹œê°„ | ~1.8Î¼s/phase | <2Î¼s | âœ… |
| CPU ì‚¬ìš©ë¥  | 18% | <30% | âœ… |
| CLA ë ˆì´í„´ì‹œ | 10Î¼s | <20Î¼s | âœ… |
| CAN ë²„ìŠ¤ ë¶€í•˜ | 25% | <50% | âœ… |
| ì½”ë“œ í¬ê¸° (Flash) | ~50KB | <128KB | âœ… |
| RAM ì‚¬ìš©ëŸ‰ | ~8KB | <32KB | âœ… |

---

## ğŸ›¡ï¸ ì•ˆì „ ì²´í¬ë¦¬ìŠ¤íŠ¸

### ì‹œìŠ¤í…œ ì‹œì‘ ì „
- [ ] ë¹„ìƒ ì •ì§€ ìŠ¤ìœ„ì¹˜ ì •ìƒ ë™ì‘ í™•ì¸
- [ ] ì „ì•• ì„¼ì„œ ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ê²€ì¦ (Â±1% ì˜¤ì°¨)
- [ ] CAN í†µì‹  ì •ìƒ (ìŠ¬ë ˆì´ë¸Œ ì‘ë‹µ í™•ì¸)
- [ ] ë³´í˜¸ ì„ê³„ê°’ ì„¤ì • í™•ì¸
- [ ] ë¦´ë ˆì´ ë™ì‘ í…ŒìŠ¤íŠ¸ (ìˆ˜ë™ ì œì–´)

### ì½”ë“œ ìˆ˜ì • í›„
- [ ] RAMFUNC ì„¹ì…˜ ë°°ì¹˜ í™•ì¸ (ISR í•¨ìˆ˜)
- [ ] ì „ì—­ ë³€ìˆ˜ ì´ˆê¸°í™” í™•ì¸
- [ ] CLA ê³µìœ  ë³€ìˆ˜ ë©”ëª¨ë¦¬ ë§¤í•‘ í™•ì¸
- [ ] ì¸í„°ëŸ½íŠ¸ ìš°ì„ ìˆœìœ„ ì¶©ëŒ ì—†ìŒ
- [ ] Watchdog ì„œë¹„ìŠ¤ ëˆ„ë½ ì—†ìŒ

### ë°°í¬ ì „
- [ ] `ENABLE_TIMING_DEBUG = 0` (ë¦´ë¦¬ìŠ¤ ë¹Œë“œ)
- [ ] ë””ë²„ê·¸ í”Œë˜ê·¸ ëª¨ë‘ ë¹„í™œì„±í™”
- [ ] Flash ë¹Œë“œ êµ¬ì„± í™•ì¸
- [ ] ë²„ì „ ë²ˆí˜¸ ì—…ë°ì´íŠ¸
- [ ] CLAUDE.md ë¬¸ì„œ ì—…ë°ì´íŠ¸

---

## ğŸ”— ë¹ ë¥¸ ë§í¬

- **ì „ì²´ ë¬¸ì„œ ì¸ë±ìŠ¤**: [PROJECT_INDEX.md](./PROJECT_INDEX.md)
- **ì½”ë“œ ë¶„ì„ ë³´ê³ ì„œ**: [CODE_ANALYSIS_REPORT.md](./CODE_ANALYSIS_REPORT.md)
- **SCADA í”„ë¡œí† ì½œ**: [RS232_interface_protocol_rev4.md](./RS232_interface_protocol_rev4.md)
- **ê°œë°œ ê°€ì´ë“œ**: [../CLAUDE.md](../CLAUDE.md)

---

## ğŸ“ ê¸´ê¸‰ ë¬¸ì œ í•´ê²°

### ë¬¸ì œ: ì‹œìŠ¤í…œ ë¶€íŒ… ì•ˆ ë¨
1. Watchdog íƒ€ì„ì•„ì›ƒ í™•ì¸ (`SysCtl_serviceWatchdog()` í˜¸ì¶œ ì—¬ë¶€)
2. Flash í”„ë¡œê·¸ë˜ë° ì„±ê³µ í™•ì¸ (CCS ë¡œê·¸)
3. í´ëŸ­ ì„¤ì • í™•ì¸ (`Device_init()`)
4. RAMFUNC ë³µì‚¬ í™•ì¸ (`memcpy` ì„±ê³µ ì—¬ë¶€)

### ë¬¸ì œ: ì œì–´ ë°œì‚°
1. PI ê²Œì¸ ì ˆë°˜ìœ¼ë¡œ ê°ì†Œ (Kp, Ki)
2. ì „ì•• í”¼ë“œë°± ì‹ í˜¸ í™•ì¸ (`V_fb`)
3. CLA Task ì‹¤í–‰ í™•ì¸ (`cla_cnt` ì¦ê°€ ì—¬ë¶€)
4. ì „ë¥˜ ì œí•œ í™•ì¸ (`I_cmd_PI_limited` ë²”ìœ„)

### ë¬¸ì œ: í†µì‹  ëŠê¹€
1. CAN: í„°ë¯¸ë„¤ì´ì…˜ ì €í•­ í™•ì¸ (120Î© Ã— 2)
2. RS485: DE (Driver Enable) GPIO í† ê¸€ í™•ì¸
3. SCADA: ë³´ë“œë ˆì´íŠ¸ ì¼ì¹˜ í™•ì¸ (115200)
4. ê³µí†µ: ì˜¤ì‹¤ë¡œìŠ¤ì½”í”„ë¡œ ì‹ í˜¸ íŒŒí˜• í™•ì¸

---

**ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸**: 2025ë…„ 10ì›” 19ì¼
**ë¬¸ì„œ ë²„ì „**: 1.0
